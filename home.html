<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Project Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b);
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .logo-icon {
            background: #3b82f6;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 1;
            max-width: 600px;
            margin: 0 auto 25px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            text-align: center;
            min-width: 150px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 1;
        }



        .stat-item:nth-child(2) {
            /* On Track - Green theme */
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 1px solid linear-gradient(135deg, #10b981 0%, #059669 100%);
            ;
        }

        .stat-item:nth-child(3) {
            /* At Risk - Yellow/Orange theme */
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: 1px solid linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-item:nth-child(4) {
            /* Critical - Red theme */
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: 1px solid linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }


        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 45px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .filter-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        select {
            padding: 14px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .clear-filters-btn {
            padding: 14px 20px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .clear-filters-btn:hover {
            background: #e2e8f0;
            color: #475569;
        }

        .clear-filters-btn:active {
            background: #cbd5e1;
            transform: translateY(1px);
        }

        .active-filters-indicator {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
            font-style: italic;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 520px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            padding: 20px;
            color: white;
            position: relative;
            min-height: 100px;
            /* Fixed minimum height */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-header.on-track {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .card-header.at-risk {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .card-header.critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .card-header.default {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .project-name {
            font-size: 1.2rem;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.6em;
            /* Ensures consistent height for 2 lines */
        }

        .client-name {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.9;
            min-height: 1.2em;
            /* Ensures consistent height */
        }

        .card-body {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }


        .project-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .detail-label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.85rem;
        }

        .detail-value {
            font-weight: 500;
            font-size: 0.85rem;
            text-align: right;
        }

        .status-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-green {
            background-color: #10b981;
        }

        .status-yellow {
            background-color: #f59e0b;
        }

        .status-red {
            background-color: #ef4444;
        }

        .divider {
            height: 1px;
            background-color: #e2e8f0;
            margin: 15px 0;
        }

        .progress-section {
            margin-bottom: 6px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.9rem;
        }

        .progress-value {
            font-weight: 600;
            color: #3b82f6;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #1e40af 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .funding-progress {
            margin-top: 10px;
            padding: 12px;
            background-color: #f0f9ff;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .funding-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .funding-progress-label {
            font-weight: 600;
            color: #1e40af;
            font-size: 0.85rem;
        }

        .funding-progress-value {
            font-weight: 700;
            color: #059669;
            font-size: 0.9rem;
        }

        .funding-progress-bar {
            height: 6px;
            background-color: #dbeafe;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2px;
        }

        .funding-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .funding-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #475569;
            margin-top: 5px;
        }

        .progress-details {
            font-size: 0.85rem;
            color: #475569;
            line-height: 1.5;
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .progress-details.expandable {
            cursor: pointer;
        }

        .progress-details.expandable::after {
            content: "...";
            position: absolute;
            bottom: 0;
            right: 0;
            background: white;
            padding-left: 5px;
        }

        .progress-details.full-text {
            max-height: none;
            overflow: visible;
        }

        .progress-details.full-text::after {
            display: none;
        }

        .card-body {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .card-footer {
            padding: 15px 20px;
            /* Increased padding for better spacing */
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            min-height: 60px;
            /* Fixed footer height */
        }

        .project-code {
            font-weight: 600;
            color: #3b82f6;
            font-size: 0.85rem;
        }

        .project-date {
            font-weight: 500;
            color: #64748b;
            font-size: 0.85rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-content {
            background: white;
            margin: 40px auto;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            color: white;
        }

        .modal-header.on-track {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .modal-header.at-risk {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .modal-header.critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .modal-header.default {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .modal-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 80px;
            height: 33px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 15px;
        }

        .modal-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1e293b;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .modal-detail {
            margin-bottom: 15px;
        }

        .modal-detail-label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .modal-detail-value {
            font-weight: 500;
            color: #1e293b;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
        }

        .project-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .project-link:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #64748b;
            grid-column: 1 / -1;
        }

        .error {
            text-align: center;
            padding: 60px;
            background-color: #fef2f2;
            color: #dc2626;
            border-radius: 12px;
            margin: 20px 0;
            grid-column: 1 / -1;
            border: 1px solid #fecaca;
        }

        .no-results {
            text-align: center;
            padding: 60px;
            background-color: #f8fafc;
            color: #64748b;
            border-radius: 12px;
            margin: 20px 0;
            grid-column: 1 / -1;
            border: 1px solid #e2e8f0;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: #64748b;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Financial amounts styling */
        .amount-display {
            font-weight: 600;
            color: #059669;
        }

        .amount-row {
            background: #f0f9ff;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #3b82f6;
        }

        /* Budget stats specific */
        .budget-stat-percentage {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .budget-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 25px;
        }

        .budget-stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .budget-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .budget-stat-label {
            font-size: 0.9rem;
            opacity: 10;
            margin-bottom: 5px;
        }

        .budget-stat-subtitle {
            font-size: 0.75rem;
            opacity: 1;
        }

        .conversion-note {
            font-size: 0.8rem;
            opacity: 1;
            margin-top: 10px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .projects-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .budget-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-detail-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .projects-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .budget-stats {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
                min-width: unset;
            }

            .filter-section {
                width: 100%;
                justify-content: space-between;
            }

            select {
                flex: 1;
                min-width: unset;
            }

            .clear-filters-btn {
                width: 100%;
                justify-content: center;
            }

            h1 {
                font-size: 2.2rem;
            }

            .stats,
            .budget-stats {
                gap: 15px;
            }

            .stat-item,
            .budget-stat-item {
                padding: 15px 20px;
                min-width: 120px;
            }

            .modal-content {
                width: 95%;
                margin: 20px auto;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-body {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            header {
                padding: 30px 15px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .subtitle {
                font-size: 1.1rem;
            }

            .controls {
                padding: 15px;
            }

            .filter-section {
                flex-direction: column;
                gap: 10px;
            }

            select {
                width: 100%;
            }

            .clear-filters-btn {
                width: 100%;
            }

            .projects-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .project-card {
                height: 500px;
                min-height: 550px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Projects</h1>
            <p class="subtitle">Strategic overview of corporate initiatives and client engagements of Maxwell Stamp LTD.
            </p>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalProjects">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="onTrackProjects">0</div>
                    <div class="stat-label">On Track</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="atRiskProjects">0</div>
                    <div class="stat-label">At Risk</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="criticalProjects">0</div>
                    <div class="stat-label">Critical</div>
                </div>
            </div>
            <div class="budget-stats">
                <div class="budget-stat-item">
                    <div class="budget-stat-value" id="totalBudget">$0</div>
                    <div class="budget-stat-percentage" id="totalBudgetPercentage">100%</div>

                    <div class="budget-stat-label">Total Contract Value</div>
                </div>
                <div class="budget-stat-item">
                    <div class="budget-stat-value" id="totalFundClaimed">$0</div>
                    <div class="budget-stat-percentage" id="totalFundClaimedPercentage">0%</div>
                    <div class="budget-stat-label">Total Funds Claimed</div>
                </div>
                <div class="budget-stat-item">
                    <div class="budget-stat-value" id="totalFundReceived">$0</div>
                    <div class="budget-stat-percentage" id="totalFundReceivedPercentage">0%</div>
                    <div class="budget-stat-label">Total Funds Received</div>
                </div>
                <div class="budget-stat-item">
                    <div class="budget-stat-value" id="totalDue">$0</div>
                    <div class="budget-stat-percentage" id="totalDuePercentage">0%</div>
                    <div class="budget-stat-label">Total Outstanding</div>
                </div>
            </div>


        </header>

        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Search projects by name, client, or sector...">
            </div>
            <div class="filter-section">
                <select id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="ðŸŸ¢">On Track</option>
                    <option value="ðŸŸ¡">At Risk</option>
                    <option value="ðŸ”´">Critical</option>
                </select>
                <select id="sectorFilter">
                    <option value="">All Sectors</option>
                </select>
                <select id="countryFilter">
                    <option value="">All Countries</option>
                </select>
                <button id="clearFiltersBtn" class="clear-filters-btn">
                    <i class="fas fa-times-circle"></i>
                    Clear Filters
                </button>
            </div>
        </div>

        <div id="activeFiltersIndicator" class="active-filters-indicator" style="display: none;"></div>

        <div id="projectsContainer" class="projects-grid">
            <div class="loading">
                <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>
                Loading corporate projects...
            </div>
        </div>

    </div>

    <!-- Modal for project details -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <div>
                    <h2 class="modal-title" id="modalProjectName">Project Name</h2>
                    <p class="modal-subtitle" id="modalClientName">Client Name</p>
                </div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3 class="modal-section-title">Project Overview</h3>
                    <div class="modal-detail-grid">
                        <div class="modal-detail">
                            <div class="modal-detail-label">Project Code</div>
                            <div class="modal-detail-value" id="modalProjectCode">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Sector</div>
                            <div class="modal-detail-value" id="modalSector">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Country</div>
                            <div class="modal-detail-value" id="modalCountry">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Status</div>
                            <div class="modal-detail-value" id="modalStatus">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Awarded Year</div>
                            <div class="modal-detail-value" id="modalAwardedYear">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Donor Name</div>
                            <div class="modal-detail-value" id="modalDonorName">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Lead</div>
                            <div class="modal-detail-value" id="modalLead">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Partner</div>
                            <div class="modal-detail-value" id="modalPartner">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Assigned To</div>
                            <div class="modal-detail-value" id="modalAssignedTo">N/A</div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title">Financial Information</h3>
                    <div class="modal-detail-grid">
                        <div class="modal-detail">
                            <div class="modal-detail-label">Contract Amount (MSL)</div>
                            <div class="modal-detail-value amount-display" id="modalContractAmount">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Fund Claimed</div>
                            <div class="modal-detail-value amount-display" id="modalFundClaimed">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Fund Received</div>
                            <div class="modal-detail-value amount-display" id="modalFundReceived">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Total Due</div>
                            <div class="modal-detail-value amount-display" id="modalTotalDue">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">USD Equivalent (Total)</div>
                            <div class="modal-detail-value amount-display" id="modalTotalUSD">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Funding Progress</div>
                            <div class="modal-detail-value amount-display" id="modalFundingProgress">N/A</div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title">Timeline & Status</h3>
                    <div class="modal-detail-grid">
                        <div class="modal-detail">
                            <div class="modal-detail-label">Start Date</div>
                            <div class="modal-detail-value" id="modalStartDate">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">End Date</div>
                            <div class="modal-detail-value" id="modalEndDate">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Contract Signed Date</div>
                            <div class="modal-detail-value" id="modalContractDate">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Status Date</div>
                            <div class="modal-detail-value" id="modalStatusDate">N/A</div>
                        </div>
                        <div class="modal-detail">
                            <div class="modal-detail-label">Current Progress</div>
                            <div class="modal-detail-value" id="modalProgress">N/A</div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title">Project Details</h3>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Key Risks / Challenges</div>
                        <div class="modal-detail-value" id="modalKeyRisks">N/A</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Next Milestone</div>
                        <div class="modal-detail-value" id="modalNextMilestone">N/A</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Remarks</div>
                        <div class="modal-detail-value" id="modalRemarks">N/A</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="project-code" id="modalFooterCode">Project Code</div>
                <a href="#" class="project-link" id="modalProjectLink" target="_blank">
                    <i class="fas fa-external-link-alt"></i>
                    View Project Website
                </a>
            </div>
        </div>
    </div>

    <script>
        // API URL
        const apiUrl = 'https://api.sheetbest.com/sheets/5b373687-9204-4dbd-893f-3be5c33555c0/tabs/Dashboard%20-%20Ongoing%20Prj';

        // DOM Elements
        const projectsContainer = document.getElementById('projectsContainer');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const sectorFilter = document.getElementById('sectorFilter');
        const countryFilter = document.getElementById('countryFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const activeFiltersIndicator = document.getElementById('activeFiltersIndicator');
        const totalProjectsEl = document.getElementById('totalProjects');
        const onTrackProjectsEl = document.getElementById('onTrackProjects');
        const atRiskProjectsEl = document.getElementById('atRiskProjects');
        const criticalProjectsEl = document.getElementById('criticalProjects');
        const totalBudgetEl = document.getElementById('totalBudget');
        const totalFundClaimedEl = document.getElementById('totalFundClaimed');
        const totalFundReceivedEl = document.getElementById('totalFundReceived');
        const totalDueEl = document.getElementById('totalDue');

        // Modal Elements
        const projectModal = document.getElementById('projectModal');
        const modalHeader = document.getElementById('modalHeader');
        const modalProjectName = document.getElementById('modalProjectName');
        const modalClientName = document.getElementById('modalClientName');
        const modalProjectCode = document.getElementById('modalProjectCode');
        const modalSector = document.getElementById('modalSector');
        const modalCountry = document.getElementById('modalCountry');
        const modalContractAmount = document.getElementById('modalContractAmount');
        const modalFundClaimed = document.getElementById('modalFundClaimed');
        const modalFundReceived = document.getElementById('modalFundReceived');
        const modalTotalDue = document.getElementById('modalTotalDue');
        const modalTotalUSD = document.getElementById('modalTotalUSD');
        const modalFundingProgress = document.getElementById('modalFundingProgress');
        const modalAwardedYear = document.getElementById('modalAwardedYear');
        const modalDonorName = document.getElementById('modalDonorName');
        const modalLead = document.getElementById('modalLead');
        const modalPartner = document.getElementById('modalPartner');
        const modalAssignedTo = document.getElementById('modalAssignedTo');
        const modalStartDate = document.getElementById('modalStartDate');
        const modalEndDate = document.getElementById('modalEndDate');
        const modalContractDate = document.getElementById('modalContractDate');
        const modalStatus = document.getElementById('modalStatus');
        const modalStatusDate = document.getElementById('modalStatusDate');
        const modalProgress = document.getElementById('modalProgress');
        const modalKeyRisks = document.getElementById('modalKeyRisks');
        const modalNextMilestone = document.getElementById('modalNextMilestone');
        const modalRemarks = document.getElementById('modalRemarks');
        const modalFooterCode = document.getElementById('modalFooterCode');
        const modalProjectLink = document.getElementById('modalProjectLink');
        const closeModalBtn = document.querySelector('.close-modal');

        // Store projects data
        let projects = [];
        let filteredProjects = [];

        // Currency conversion rates (to USD)
        // Using approximate exchange rates - you can update these as needed
        const conversionRates = {
            'USD': 1,
            '$': 1,
            'US$': 1,
            'PKR': 0.0036,      // 1 PKR = 0.0036 USD (approx)
            'INR': 0.012,       // 1 INR = 0.012 USD (approx)
            'EUR': 1.08,        // 1 EUR = 1.08 USD (approx)
            'â‚¬': 1.08,
            'GBP': 1.27,        // 1 GBP = 1.27 USD (approx)
            'Â£': 1.27,
            'CAD': 0.73,        // 1 CAD = 0.73 USD (approx)
            'AUD': 0.66,        // 1 AUD = 0.66 USD (approx)
            'JPY': 0.0067,      // 1 JPY = 0.0067 USD (approx)
            'CNY': 0.14,        // 1 CNY = 0.14 USD (approx)
            'CHF': 1.12,        // 1 CHF = 1.12 USD (approx)
            'AED': 0.27,        // 1 AED = 0.27 USD (approx)
            'SAR': 0.27,        // 1 SAR = 0.27 USD (approx)
            'BDT': 0.0091,      // 1 BDT = 0.0091 USD (approx)
            'LKR': 0.0031,      // 1 LKR = 0.0031 USD (approx)
            'NPR': 0.0075,      // 1 NPR = 0.0075 USD (approx)
            'MMK': 0.00048,     // 1 MMK = 0.00048 USD (approx)
            'IDR': 0.000064,    // 1 IDR = 0.000064 USD (approx)
            'THB': 0.027,       // 1 THB = 0.027 USD (approx)
            'PHP': 0.018,       // 1 PHP = 0.018 USD (approx)
            'VND': 0.000041,    // 1 VND = 0.000041 USD (approx)
            'MYR': 0.21,        // 1 MYR = 0.21 USD (approx)
            'SGD': 0.74,        // 1 SGD = 0.74 USD (approx)
            'HKD': 0.13,        // 1 HKD = 0.13 USD (approx)
            'KRW': 0.00075,     // 1 KRW = 0.00075 USD (approx)
            'BRL': 0.20,        // 1 BRL = 0.20 USD (approx)
            'MXN': 0.059,       // 1 MXN = 0.059 USD (approx)
            'RUB': 0.011,       // 1 RUB = 0.011 USD (approx)
            'ZAR': 0.055,       // 1 ZAR = 0.055 USD (approx)
            'NGN': 0.00067,     // 1 NGN = 0.00067 USD (approx)
            'EGP': 0.032,       // 1 EGP = 0.032 USD (approx)
            'KES': 0.0068,      // 1 KES = 0.0068 USD (approx)
            'GHS': 0.078,       // 1 GHS = 0.078 USD (approx)
            'ETB': 0.018        // 1 ETB = 0.018 USD (approx)
        };

        // Function to detect currency from string
        function detectCurrency(amountString) {
            if (!amountString) return 'USD';

            const upperStr = amountString.toUpperCase();

            // Check for US$ (needs to be before checking for $ alone)
            if (upperStr.includes('US$')) return 'USD';

            // Check for other currency patterns
            if (upperStr.includes('PKR') || upperStr.includes('RS')) return 'PKR';
            if (upperStr.includes('INR') || upperStr.includes('â‚¹')) return 'INR';
            if (upperStr.includes('EUR') || upperStr.includes('â‚¬')) return 'EUR';
            if (upperStr.includes('GBP') || upperStr.includes('Â£')) return 'GBP';
            if (upperStr.includes('BDT') || upperStr.includes('à§³')) return 'BDT';

            // Check for $ last (after checking for US$)
            if (upperStr.includes('$')) return 'USD';

            // If no currency symbol but has numbers, assume USD
            if (/\d/.test(amountString)) return 'USD';

            return 'USD'; // Default fallback
        }
        function extractAndConvertToUSD(amountString) {
            if (!amountString || amountString.trim() === '') return 0;

            const amount = amountString.trim();
            let totalUSD = 0;

            const singleAmountMatch = amount.match(/^([^0-9]*?)([\d,.]+)$/);
            if (singleAmountMatch && !amount.toLowerCase().includes('and')) {
                const [, currencyPart, numericPart] = singleAmountMatch;
                const numericValue = parseFloat(numericPart.replace(/,/g, '')) || 0;
                const currency = detectCurrency(currencyPart.trim() || amount);
                const rate = conversionRates[currency] || 1;
                return numericValue * rate;
            }

            // FIX: Split on "and" with any whitespace (including newlines) around it
            const parts = amount.split(/\s+and\s+/i);

            parts.forEach(part => {
                const trimmedPart = part.trim();
                if (!trimmedPart) return;
                console.log("USD Trimmed part", trimmedPart);

                // Extract numeric value - improved regex
                const numericMatch = trimmedPart.match(/([\d,.]+)/);
                if (!numericMatch) return;

                console.log("USD Numeric Match", numericMatch);
                const numericString = numericMatch[1].replace(/,/g, '');
                const numericValue = parseFloat(numericString) || 0;

                if (numericValue > 0) {
                    // Detect currency - pass the entire part
                    const currency = detectCurrency(trimmedPart);

                    // Get conversion rate
                    const rate = conversionRates[currency] || 1;

                    totalUSD += numericValue * rate;
                }
            });

            return totalUSD;
        }
        function calculateFundingProgress(contractAmountUSD, fundReceivedUSD) {
            if (!contractAmountUSD || contractAmountUSD <= 0) return 0;
            if (!fundReceivedUSD || fundReceivedUSD <= 0) return 0;

            // Calculate percentage
            const percentage = (fundReceivedUSD / contractAmountUSD) * 100;

            // Cap at 100%
            return Math.min(percentage, 100);
        }

        // Function to parse date in "dd MMM yyyy" format (e.g., "28 Feb 2023")
        function parseDate(dateString) {
            if (!dateString || dateString.trim() === '') return null;

            try {
                const parts = dateString.trim().split(' ');
                if (parts.length < 3) return null;

                const day = parseInt(parts[0]);
                const monthStr = parts[1].toLowerCase();
                const year = parseInt(parts[2]);

                const monthMap = {
                    'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5,
                    'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11
                };

                const month = monthMap[monthStr.substring(0, 3)];
                if (month === undefined) return null;

                return new Date(year, month, day);
            } catch (e) {
                console.error('Error parsing date:', dateString, e);
                return null;
            }
        }

        // Function to parse amount strings with mixed currencies for display
        function parseAmountString(amountString) {
            if (!amountString || amountString.trim() === '') return 'N/A';

            const amount = amountString.trim();

            // Check for "and" separated amounts
            if (amount.toLowerCase().includes(' and ')) {
                const parts = amount.split(/ and /i);
                return parts.map(part => {
                    const trimmedPart = part.trim();
                    // Try to format each part with currency
                    const currencyMatch = trimmedPart.match(/^([^\d]+)?([\d,.]+)$/);
                    if (currencyMatch) {
                        const [, currency, value] = currencyMatch;
                        return (currency ? currency.trim() + ' ' : '') + formatWithCommas(value.trim());
                    }
                    return formatWithCommas(trimmedPart);
                }).join(' + ');
            }

            // Handle single amount
            const currencyMatch = amount.match(/^([^\d]+)?([\d,.]+)$/);
            if (currencyMatch) {
                const [, currency, value] = currencyMatch;
                return (currency ? currency.trim() + ' ' : '$ ') + formatWithCommas(value.trim());
            }

            return formatWithCommas(amount);
        }
        function formatAmountForCard(amountString) {
            if (!amountString || amountString.trim() === '') return 'N/A';

            const amount = amountString.trim();

            if (amount.toLowerCase().includes(' and ')) {
                const parts = amount.split(/ and /i);
                const firstAmount = parts[0].trim();

                const currencyMatch = firstAmount.match(/^(PKR|US\$|\$|â‚¬|Â£|Â¥|â‚¹|Rs|AED|SAR)/i);
                if (currencyMatch) {
                    const currency = currencyMatch[1];
                    const value = formatWithCommas(firstAmount.substring(currencyMatch[0].length).trim());

                    if (parts.length > 1) {
                        return `${currency} ${value}<br><span style="font-size: 0.75rem; color: #64748b;">+ ${parts.length - 1} more</span>`;
                    }
                    return `${currency} ${value}`;
                }
            }

            return parseAmountString(amount);
        }

        // Helper function to add commas to numbers
        function formatWithCommas(text) {
            if (!text) return text;

            // Handle numbers with M suffix (millions)
            const millionMatch = text.match(/^([\d,.]+)\s*M$/i);
            if (millionMatch) {
                const numberPart = millionMatch[1].replace(/,/g, '');
                const num = parseFloat(numberPart);
                if (!isNaN(num)) {
                    // Format with 1 decimal place and add commas
                    const formatted = new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 1
                    }).format(num);
                    return formatted + 'M';
                }
            }

            // Handle numbers with K suffix (thousands)
            const thousandMatch = text.match(/^([\d,.]+)\s*K$/i);
            if (thousandMatch) {
                const numberPart = thousandMatch[1].replace(/,/g, '');
                const num = parseFloat(numberPart);
                if (!isNaN(num)) {
                    // Format with 1 decimal place and add commas
                    const formatted = new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 1
                    }).format(num);
                    return formatted + 'K';
                }
            }

            // Handle regular numbers
            return text.replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
        }

        // Function to check if project is ongoing
        function isProjectOngoing(project) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const contractDate = parseDate(project.contractSignedDate || project.startDate);
            if (!contractDate) return false;

            const endDate = parseDate(project.endDate);
            if (!endDate) return true;

            return contractDate <= today && (endDate >= today || isSameDay(endDate, today));
        }

        // Function to check if project is overdue
        function isProjectOverdue(project) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const endDate = parseDate(project.endDate);
            if (!endDate) return false;

            return endDate < today && !isSameDay(endDate, today);
        }

        // Helper function to check if two dates are the same day
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate();
        }

        // Function to extract status from status data
        function extractStatus(statusData) {
            let statusEmoji = '';
            let statusDate = '';

            if (typeof statusData === 'string') {
                if (statusData.includes('ðŸŸ¢') || statusData.includes('ðŸŸ¡') || statusData.includes('ðŸ”´')) {
                    if (statusData.includes('ðŸŸ¢')) statusEmoji = 'ðŸŸ¢';
                    else if (statusData.includes('ðŸŸ¡')) statusEmoji = 'ðŸŸ¡';
                    else if (statusData.includes('ðŸ”´')) statusEmoji = 'ðŸ”´';

                    const dateMatch = statusData.match(/\d{1,2} \w+ \d{4}/);
                    if (dateMatch) {
                        statusDate = dateMatch[0];
                    }
                }
            } else if (typeof statusData === 'object' && statusData !== null) {
                for (const key in statusData) {
                    if (key.match(/\d{1,2} \w+ \d{4}/) &&
                        (statusData[key] === 'ðŸŸ¢' || statusData[key] === 'ðŸŸ¡' || statusData[key] === 'ðŸ”´')) {
                        statusDate = key;
                        statusEmoji = statusData[key];
                        break;
                    }
                }
            }

            return {
                emoji: statusEmoji,
                date: statusDate,
                text: getStatusText(statusEmoji)
            };
        }

        // Fetch data from API
        async function fetchProjects() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const data = await response.json();

                if (data.rows) {
                    projects = data.rows.map((row, index) => {
                        const project = {
                            sl: index + 1,
                            awardedYear: row["Awarded Year"] || row["awarded_year"] || '',
                            country: row["Country"] || row["country"] || '',
                            donorName: row["Donor Name"] || row["donor_name"] || '',
                            clientName: row["Client Name"] || row["client_name"] || '',
                            projectName: row["Project Name"] || row["project_name"] || '',
                            sector: row["Sector"] || row["sector"] || '',
                            lead: row["Lead"] || row["lead"] || '',
                            partner: row["Partner"] || row["partner"] || '',
                            projectCode: row["Project Code"] || row["project_code"] || '',
                            assignedTo: row["Assigned To"] || row["assigned_to"] || '',
                            contractSignedDate: row["Contract Signed Date"] || row["contract_signed_date"] || row["Start Date"] || row["start_date"] || '',
                            startDate: row["Start Date"] || row["start_date"] || '',
                            endDate: row["End Date"] || row["end_date"] || '',
                            currentProgress: row["Current Progress"] || row["current_progress"] || '',
                            keyRisks: row["Key Risks / Challenges"] || row["key_risks"] || '',
                            nextMilestone: row["Next Milestone"] || row["next_milestone"] || '',
                            remark: row["Remark"] || row["remark"] || '',
                            contractAmount: row["Contract Amount (MSL)"] || row["contract_amount"] || '',
                            fundClaimed: row["Fund Claimed"] || row["fund_claimed"] || '',
                            fundReceived: row["Fund Received"] || row["fund_received"] || '',
                            totalDue: row["Total Due"] || row["total_due"] || '',
                            link: row["Link"] || row["link"] || null
                        };

                        // Parse status field
                        let statusData = row["1 December 2025"] || row["Status"] || row["status"] || '';
                        const statusInfo = extractStatus(statusData);

                        project.statusEmoji = statusInfo.emoji;
                        project.statusText = statusInfo.text;
                        project.statusDate = statusInfo.date;

                        // Calculate project status
                        project.isOngoing = isProjectOngoing(project);
                        project.isOverdue = isProjectOverdue(project);

                        // Extract and convert amounts to USD
                        project.usdContractAmount = extractAndConvertToUSD(project.contractAmount);

                        project.usdFundClaimed = extractAndConvertToUSD(project.fundClaimed);
                        project.usdFundReceived = extractAndConvertToUSD(project.fundReceived);
                        project.usdTotalDue = extractAndConvertToUSD(project.totalDue);

                        // Calculate total USD for this project
                        project.totalUSD = project.usdContractAmount;

                        // Calculate funding progress percentage
                        project.fundingProgressPercentage = calculateFundingProgress(
                            project.usdContractAmount,
                            project.usdFundReceived
                        );

                        return project;
                    });
                } else if (Array.isArray(data)) {
                    const headers = data[0] || [];
                    const rows = data.slice(1);

                    projects = rows.map((row, index) => {
                        const project = {
                            sl: index + 1,
                            awardedYear: row[1] || '',
                            country: row[2] || '',
                            donorName: row[3] || '',
                            clientName: row[4] || '',
                            projectName: row[5] || '',
                            sector: row[6] || '',
                            lead: row[7] || '',
                            partner: row[8] || '',
                            projectCode: row[9] || '',
                            assignedTo: row[10] || '',
                            contractSignedDate: row[11] || '',
                            startDate: row[11] || '',
                            endDate: row[12] || '',
                            currentProgress: row[14] || '',
                            keyRisks: row[15] || '',
                            nextMilestone: row[16] || '',
                            contractAmount: row[17] || '',
                            fundClaimed: row[18] || '',
                            fundReceived: row[19] || '',
                            totalDue: row[20] || '',
                            remark: row[21] || '',
                            link: row[22] || null
                        };

                        let statusData = '';
                        for (const key in row) {
                            if (key.match(/\d{1,2} \w+ \d{4}/)) {
                                statusData = row[key];
                                break;
                            }
                        }

                        const statusInfo = extractStatus(statusData);

                        project.statusEmoji = statusInfo.emoji;
                        project.statusText = statusInfo.text;
                        project.statusDate = statusInfo.date;

                        project.isOngoing = isProjectOngoing(project);
                        project.isOverdue = isProjectOverdue(project);

                        // Extract and convert amounts to USD
                        project.usdContractAmount = extractAndConvertToUSD(project.contractAmount);

                        project.usdFundClaimed = extractAndConvertToUSD(project.fundClaimed);
                        project.usdFundReceived = extractAndConvertToUSD(project.fundReceived);
                        project.usdTotalDue = extractAndConvertToUSD(project.totalDue);

                        // Calculate total USD for this project
                        project.totalUSD = project.usdContractAmount;

                        // Calculate funding progress percentage
                        project.fundingProgressPercentage = calculateFundingProgress(
                            project.usdContractAmount,
                            project.usdFundReceived
                        );

                        return project;
                    });
                } else {
                    throw new Error('Unexpected data format from API');
                }

                // Update statistics
                updateStatistics(projects);

                // Populate filter dropdowns
                populateFilters();

                // Display projects
                filteredProjects = [...projects];
                displayProjects(filteredProjects);
                updateActiveFiltersIndicator();

            } catch (error) {
                console.error('Error fetching data:', error);
                projectsContainer.innerHTML = `
                    <div class="error">
                        <h3>Error Loading Corporate Projects</h3>
                        <p>Unable to fetch project data. Please try again later.</p>
                        <p style="margin-top: 15px; font-size: 0.9rem;">Error details: ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Check browser console for more details.</p>
                    </div>
                `;
            }
        }
        function updateBudgetPercentages(totalContract, totalClaimed, totalReceived, totalDue) {
            // Get percentage display elements
            const totalBudgetPercentageEl = document.getElementById('totalBudgetPercentage');
            const totalFundClaimedPercentageEl = document.getElementById('totalFundClaimedPercentage');
            const totalFundReceivedPercentageEl = document.getElementById('totalFundReceivedPercentage');
            const totalDuePercentageEl = document.getElementById('totalDuePercentage');

            // Always show total contract value as 100%
            totalBudgetPercentageEl.textContent = "100%";

            // Calculate percentages relative to total contract value
            if (totalContract > 0) {
                const claimedPercentage = (totalClaimed / totalContract) * 100;
                const receivedPercentage = (totalReceived / totalContract) * 100;
                const duePercentage = (totalDue / totalContract) * 100;

                totalFundClaimedPercentageEl.textContent = `${claimedPercentage.toFixed(1)}%`;
                totalFundReceivedPercentageEl.textContent = `${receivedPercentage.toFixed(1)}%`;
                totalDuePercentageEl.textContent = `${duePercentage.toFixed(1)}%`;
            } else {
                totalFundClaimedPercentageEl.textContent = "0%";
                totalFundReceivedPercentageEl.textContent = "0%";
                totalDuePercentageEl.textContent = "0%";
            }

            updatePercentageColors(totalFundClaimedPercentageEl, totalFundReceivedPercentageEl, totalDuePercentageEl);
        }

        // Function to add color coding to percentages
        // Function to add color coding to percentages
        function updatePercentageColors(claimedEl, receivedEl, dueEl) {
            // Parse percentage values
            const claimedPercent = parseFloat(claimedEl.textContent);
            const receivedPercent = parseFloat(receivedEl.textContent);
            const duePercent = parseFloat(dueEl.textContent);

            // Set colors based on percentage ranges
            claimedEl.style.color = claimedPercent >= 70 ? '#10b981' :
                claimedPercent >= 50 ? '#f59e0b' : '#ef4444';

            receivedEl.style.color = receivedPercent >= 70 ? '#10b981' :
                receivedPercent >= 50 ? '#f59e0b' : '#ef4444';

            dueEl.style.color = duePercent <= 20 ? '#10b981' :
                duePercent <= 50 ? '#f59e0b' : '#ef4444';
        }
        // Update statistics in the header
        function updateStatistics(projects) {
            totalProjectsEl.textContent = projects.length;

            // Count projects by status
            const onTrackCount = projects.filter(p => p.statusEmoji === 'ðŸŸ¢').length;
            const atRiskCount = projects.filter(p => p.statusEmoji === 'ðŸŸ¡').length;
            const criticalCount = projects.filter(p => p.statusEmoji === 'ðŸ”´').length;

            onTrackProjectsEl.textContent = onTrackCount;
            atRiskProjectsEl.textContent = atRiskCount;
            criticalProjectsEl.textContent = criticalCount;

            // Calculate budget statistics in USD
            let totalContractAmountUSD = 0;
            let totalFundClaimedUSD = 0;
            let totalFundReceivedUSD = 0;
            let totalDueAmountUSD = 0;

            projects.forEach(project => {
                totalContractAmountUSD += project.usdContractAmount || 0;
                totalFundClaimedUSD += project.usdFundClaimed || 0;
                totalFundReceivedUSD += project.usdFundReceived || 0;
                totalDueAmountUSD += project.usdTotalDue || 0;
            });

            // Format and display budget statistics
            totalBudgetEl.textContent = formatCurrency(totalContractAmountUSD);
            totalFundClaimedEl.textContent = formatCurrency(totalFundClaimedUSD);
            totalFundReceivedEl.textContent = formatCurrency(totalFundReceivedUSD);
            totalDueEl.textContent = formatCurrency(totalDueAmountUSD);
            updateBudgetPercentages(totalContractAmountUSD, totalFundClaimedUSD, totalFundReceivedUSD, totalDueAmountUSD);
        }

        // Function to format currency
        function formatCurrency(amount) {
            if (amount === 0) return '$0';

            if (amount >= 1000000) {
                const millions = amount / 1000000;
                // Format with commas for thousands
                const formatted = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                }).format(millions);
                return '$' + formatted + 'M';
            } else if (amount >= 1000) {
                const thousands = amount / 1000;
                // Format with commas for thousands
                const formatted = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                }).format(thousands);
                return '$' + formatted + 'K';
            } else {
                return '$' + amount.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }
        }

        // Populate filter dropdowns with unique values
        function populateFilters() {
            const sectors = [...new Set(projects.map(p => p.sector).filter(Boolean))];
            const countries = [...new Set(projects.map(p => p.country).filter(Boolean))];

            while (sectorFilter.options.length > 1) {
                sectorFilter.remove(1);
            }
            while (countryFilter.options.length > 1) {
                countryFilter.remove(1);
            }

            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });

            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        // Update active filters indicator
        function updateActiveFiltersIndicator() {
            const searchTerm = searchInput.value;
            const statusValue = statusFilter.value;
            const sectorValue = sectorFilter.value;
            const countryValue = countryFilter.value;

            const activeFilters = [];

            if (searchTerm) {
                activeFilters.push(`Search: "${searchTerm}"`);
            }
            if (statusValue) {
                const statusText = getStatusText(statusValue);
                activeFilters.push(`Status: ${statusText}`);
            }
            if (sectorValue) {
                activeFilters.push(`Sector: ${sectorValue}`);
            }
            if (countryValue) {
                activeFilters.push(`Country: ${countryValue}`);
            }

            if (activeFilters.length > 0) {
                activeFiltersIndicator.textContent = `Active filters: ${activeFilters.join(' â€¢ ')}`;
                activeFiltersIndicator.style.display = 'block';
            } else {
                activeFiltersIndicator.style.display = 'none';
            }
        }

        // Clear all filters
        function clearAllFilters() {
            // Reset all filter values
            searchInput.value = '';
            statusFilter.value = '';
            sectorFilter.value = '';
            countryFilter.value = '';

            // Reset filtered projects to all projects
            filteredProjects = [...projects];

            // Update display
            displayProjects(filteredProjects);
            updateActiveFiltersIndicator();

            // Show a brief confirmation
            const originalText = clearFiltersBtn.innerHTML;
            clearFiltersBtn.innerHTML = '<i class="fas fa-check"></i> Filters Cleared';
            clearFiltersBtn.style.background = '#10b981';
            clearFiltersBtn.style.color = 'white';
            clearFiltersBtn.style.borderColor = '#10b981';

            setTimeout(() => {
                clearFiltersBtn.innerHTML = originalText;
                clearFiltersBtn.style.background = '';
                clearFiltersBtn.style.color = '';
                clearFiltersBtn.style.borderColor = '';
            }, 1500);
        }

        // Helper function to truncate text
        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Display projects in the grid
        function displayProjects(projectsToDisplay) {
            if (projectsToDisplay.length === 0) {
                projectsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>No Projects Found</h3>
                        <p>Try adjusting your search or filters</p>
                        <button id="clearFiltersNoResults" class="clear-filters-btn" style="margin-top: 15px;">
                            <i class="fas fa-times-circle"></i>
                            Clear All Filters
                        </button>
                    </div>
                `;

                // Add event listener to clear filters button in no-results message
                const clearFiltersNoResultsBtn = document.getElementById('clearFiltersNoResults');
                if (clearFiltersNoResultsBtn) {
                    clearFiltersNoResultsBtn.addEventListener('click', clearAllFilters);
                }
                return;
            }

            projectsContainer.innerHTML = projectsToDisplay.map(project => {
                let progressDetails = project.currentProgress || 'N/A';
                let isExpandable = false;

                if (progressDetails.length > 100) {
                    progressDetails = truncateText(progressDetails, 100);
                    isExpandable = true;
                }

                const progressPercentage = getProgressPercentage(project.currentProgress);
                const showOverdue = project.isOverdue;
                const formattedContractAmount = formatAmountForCard(project.contractAmount || '');

                // Format funding progress
                const fundingProgress = project.fundingProgressPercentage || 0;
                const fundingProgressFormatted = fundingProgress > 0 ?
                    `${fundingProgress.toFixed(1)}%` : '0%';

                // Determine header class based on status
                let headerClass = 'default';
                if (project.statusEmoji === 'ðŸŸ¢') headerClass = 'on-track';
                else if (project.statusEmoji === 'ðŸŸ¡') headerClass = 'at-risk';
                else if (project.statusEmoji === 'ðŸ”´') headerClass = 'critical';

                return `
                <div class="project-card" data-project-id="${project.sl}">
                    <div class="card-header ${headerClass}">
                        <h3 class="project-name">${project.projectName || 'Unnamed Project'}</h3>
                        <p class="client-name">${project.clientName || 'N/A'}</p>
                        ${showOverdue ? '<div style="position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">OVERDUE</div>' : ''}
                    </div>
                    <div class="card-body">
                        <div class="project-details">
                            <div class="detail-row">
                                <span class="detail-label">Sector</span>
                                <span class="detail-value">${project.sector || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Country</span>
                                <span class="detail-value">${project.country || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Contract Amount</span>
                                <span class="detail-value amount-display">${formattedContractAmount}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">USD Equivalent</span>
                                <span class="detail-value amount-display">${formatCurrency(project.usdContractAmount)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status</span>
                                <div class="detail-value">
                                    <div class="status-container">
                                        <span>${project.statusText || getStatusText(project.statusEmoji)}</span>
                                    </div>
                                </div>
                            </div>
                            ${project.statusDate ? `
                            <div class="detail-row">
                                <span class="detail-label">Status Date</span>
                                <span class="detail-value">${project.statusDate}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="divider"></div>
                        
                        <div class="funding-progress">
                            <div class="funding-progress-header">
                                <span class="funding-progress-label">Funding Progress</span>
                                <span class="funding-progress-value">${fundingProgressFormatted}</span>
                            </div>
                            <div class="funding-progress-bar">
                                <div class="funding-progress-fill" style="width: ${fundingProgress}%"></div>
                            </div>
                            <div class="funding-details">
                                <span>Received: ${formatCurrency(project.usdFundReceived)}</span>
                                <span>Total: ${formatCurrency(project.usdContractAmount)}</span>
                            </div>
                        </div>
                        
                    </div>
                    <div class="card-footer">
                        <span class="project-code">${project.projectCode || 'N/A'}</span>
                        <span class="project-date">${project.awardedYear || 'N/A'}</span>
                    </div>
                </div>
                `;
            }).join('');

            // Add click event listeners to all project cards
            document.querySelectorAll('.project-card').forEach(card => {
                card.addEventListener('click', function (e) {
                    if (!e.target.classList.contains('progress-details')) {
                        const projectId = this.getAttribute('data-project-id');
                        const project = projects.find(p => p.sl === parseInt(projectId));
                        if (project) {
                            openProjectModal(project);
                        }
                    }
                });
            });
        }

        // Helper function to extract percentage from progress text
        function getProgressPercentage(progressText) {
            if (!progressText) return null;
            const match = progressText.match(/(\d+)%/);
            return match ? match[0] : null;
        }

        // Open modal with project details
        function openProjectModal(project) {
            modalProjectName.textContent = project.projectName || 'Unnamed Project';
            modalClientName.textContent = project.clientName || 'N/A';
            modalProjectCode.textContent = project.projectCode || 'N/A';
            modalSector.textContent = project.sector || 'N/A';
            modalCountry.textContent = project.country || 'N/A';
            modalContractAmount.innerHTML = parseAmountString(project.contractAmount || '');
            modalFundClaimed.innerHTML = parseAmountString(project.fundClaimed || '');
            modalFundReceived.innerHTML = parseAmountString(project.fundReceived || '');
            modalTotalDue.innerHTML = parseAmountString(project.totalDue || '');
            modalTotalUSD.textContent = formatCurrency(project.totalUSD || 0);

            // Set funding progress in modal
            const fundingProgress = project.fundingProgressPercentage || 0;
            modalFundingProgress.textContent = `${fundingProgress.toFixed(1)}%`;

            modalAwardedYear.textContent = project.awardedYear || 'N/A';
            modalDonorName.textContent = project.donorName || 'N/A';
            modalLead.textContent = project.lead || 'N/A';
            modalPartner.textContent = project.partner || 'N/A';
            modalAssignedTo.textContent = project.assignedTo || 'N/A';
            modalStartDate.textContent = project.startDate || 'N/A';
            modalEndDate.textContent = project.endDate || 'N/A';
            modalContractDate.textContent = project.contractSignedDate || 'N/A';
            modalStatus.innerHTML = `${project.statusText || getStatusText(project.statusEmoji)}`;
            modalStatusDate.textContent = project.statusDate || 'N/A';
            modalProgress.textContent = project.currentProgress || 'N/A';
            modalKeyRisks.textContent = project.keyRisks || 'N/A';
            modalNextMilestone.textContent = project.nextMilestone || 'N/A';
            modalRemarks.textContent = project.remark || 'N/A';
            modalFooterCode.textContent = project.projectCode || 'N/A';

            // Set modal header class based on status
            let headerClass = 'default';
            if (project.statusEmoji === 'ðŸŸ¢') headerClass = 'on-track';
            else if (project.statusEmoji === 'ðŸŸ¡') headerClass = 'at-risk';
            else if (project.statusEmoji === 'ðŸ”´') headerClass = 'critical';

            modalHeader.className = 'modal-header ' + headerClass;

            // Set project link
            if (project.link) {
                modalProjectLink.href = project.link;
                modalProjectLink.style.display = 'inline-flex';
            } else {
                modalProjectLink.style.display = 'none';
            }

            projectModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal() {
            projectModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Helper function to get status text
        function getStatusText(status) {
            if (status === 'ðŸŸ¢') return 'On Track';
            if (status === 'ðŸŸ¡') return 'At Risk';
            if (status === 'ðŸ”´') return 'Critical';
            return status || 'Unknown';
        }

        // Filter projects based on search and filters
        function filterProjects() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            const sectorValue = sectorFilter.value;
            const countryValue = countryFilter.value;

            filteredProjects = projects.filter(project => {
                const matchesSearch = !searchTerm ||
                    (project.projectName && project.projectName.toLowerCase().includes(searchTerm)) ||
                    (project.clientName && project.clientName.toLowerCase().includes(searchTerm)) ||
                    (project.projectCode && project.projectCode.toLowerCase().includes(searchTerm)) ||
                    (project.sector && project.sector.toLowerCase().includes(searchTerm));

                const matchesStatus = !statusValue || project.statusEmoji === statusValue;
                const matchesSector = !sectorValue || project.sector === sectorValue;
                const matchesCountry = !countryValue || project.country === countryValue;

                return matchesSearch && matchesStatus && matchesSector && matchesCountry;
            });

            displayProjects(filteredProjects);
            updateActiveFiltersIndicator();
        }

        // Event listeners for filtering
        searchInput.addEventListener('input', filterProjects);
        statusFilter.addEventListener('change', filterProjects);
        sectorFilter.addEventListener('change', filterProjects);
        countryFilter.addEventListener('change', filterProjects);

        // Event listener for clear filters button
        clearFiltersBtn.addEventListener('click', clearAllFilters);

        // Event listeners for modal
        closeModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', function (event) {
            if (event.target === projectModal) {
                closeModal();
            }
        });

        // Initialize
        fetchProjects();
    </script>
</body>

</html>